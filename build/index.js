'use strict';const https=require('https'),http=require('http'),path=require('path'),zlib=require('zlib'),pat=require('path'),net=require('net'),dns=require('dns'),fs=require('fs'),os=require('os');var doneexpress=![];exports=module['exports']=main;function main(f={'forceCompressionType':'gzip','forceCompression':![],'minCompression':0x0,'changeSendFile':!![],'changeSend':!![],'changeJson':!![],'cacheControl':'no-cache','flush':!![],'flushInterval':0x5dc,'changeExIp':!![],'returnIpType':'ipv4','returnMultiIp':![],'autoType':!![],'secure':!![]}){f=f||{};f['forceCompressionType']==undefined&&(f['forceCompressionType']='gzip');f['forceCompression']==undefined&&(f['forceCompression']=![]);f['changeSendFile']==undefined&&(f['changeSendFile']=!![]);f['changeSend']==undefined&&(f['changeSend']=!![]);f['cacheControl']==undefined&&(f['cacheControl']='no-cache');f['flushInterval']==undefined&&(f['flushInterval']=0x5dc);f['changeExIp']==undefined&&(f['changeExIp']=!![]);f['returnMultiIp']==undefined&&(f['returnMultiIp']=![]);f['returnIpType']==undefined&&(f['returnIpType']='ipv4');f['flush']==undefined&&(f['flush']=!![]);f['minCompression']==undefined&&(f['minCompression']=0x0);f['changeJson']==undefined&&(f['changeJson']=!![]);f['changeJsonp']==undefined&&(f['changeJsonp']=!![]);f['changeWrite']==undefined&&(f['changeWrite']=!![]);f['autoType']==undefined&&(f['autoType']=!![]);f['changeExResponseTime']==undefined&&(f['changeExResponseTime']=!![]);(f['secure']==undefined||f['secure']=={})&&(f['secure']=!![]);f['forceCompressionType']=f['forceCompressionType']['toLowerCase'](),f['cacheControl']=f['cacheControl']['toLowerCase'](),f['returnIpType']=f['returnIpType']['toLowerCase'](),f['minCompression']=parseInt(f['minCompression']),f['flushInterval']=parseInt(f['flushInterval']);return function(H,R,b){if(doneexpress==![]){doneexpress=!![];const n=R['app'];f['secure']==!![]&&(n['disable']('x-powered-by'),n['set']('etag','strong'),dns['lookup'](os['hostname'](),function(l,o,d){n['set']('trust\x20proxy',S=>{return S==o||S=='127.0.0.1'||S=='127.0.0.8'||S=='::128'||S=='::1'||S=='169.254.0.0'||S=='196.254.0.16'||S=='fe80::'||S=='fe80::10'||S=='10.0.0.0'||S=='10.0.0.8'||S=='172.16.0.0'||S=='172.16.0.12'||S=='192.168.0.0'||S=='192.168.0.16'||S=='fc00::'||S=='fc00::7'?!![]:![];});}));}f['changeSendFile']==!![]&&(R['sendFile']=function(l,o){try{R['set']({'Cache-Control':f['cacheControl']});var d=H['headers']['accept-encoding'];!d&&(d='');}catch(A){o!=undefined?o(A):console['error'](A);R['end'](new Buffer['from'](A['toString']()));return;}var S=pat['extname'](l);fs['readFile'](l,(O,F)=>{if(O){o!=undefined?o(O):console['error'](O);R['end'](new Buffer['from'](O['toString']()));return;}var x=new Buffer['from'](F);if(f['forceCompression']==![]){if(d['match'](/\bgzip\b/))zlib['gzip'](x,(u,g)=>{if(u){o!=undefined?o(u):console['error'](u);R['end'](new Buffer['from'](u['toString']()));return;}else R['set']({'Content-Encoding':'gzip'}),f['autoType']==!![]&&R['set']({'Content-Type':S}),R['end'](g);});else{if(d['match'](/\bdeflate\b/))zlib['deflate'](x,(u,g)=>{if(u){o!=undefined?o(u):console['error'](u);R['end'](new Buffer['from'](u['toString']()));return;}else R['set']({'Content-Encoding':'deflate'}),f['autoType']==!![]&&R['set']({'Content-Type':S}),R['end'](g);});else{if(d['match'](/\bbr\b/))zlib['brotliCompress'](x,(u,g)=>{if(u){o!=undefined?o(u):console['error'](u);R['end'](new Buffer['from'](u['toString']()));return;}else R['set']({'Content-Encoding':'br'}),f['autoType']==!![]&&R['set']({'Content-Type':S}),R['end'](g);});else try{R['end'](x);}catch(u){o!=undefined?o(u):console['error'](u);R['end'](new Buffer['from'](u['toString']()));return;}}}}else{if(f['forceCompressionType']=='gzip')try{zlib['gzip'](x,(g,Y)=>{if(g){o!=undefined?o(g):console['error'](g);R['end'](new Buffer['from'](g['toString']()));return;}else R['set']({'Content-Encoding':'gzip'}),f['autoType']==!![]&&R['set']({'Content-Type':S}),R['end'](Y);});}catch(g){o!=undefined?o(g):console['error'](g);R['end'](new Buffer['from'](g['toString']()));return;}else{if(f['forceCompressionType']=='deflate')try{zlib['deflate'](x,(Y,I)=>{if(Y){o!=undefined?o(Y):console['error'](Y);R['end'](new Buffer['from'](Y['toString']()));return;}else R['set']({'Content-Encoding':'deflate'}),f['autoType']==!![]&&R['set']({'Content-Type':S}),R['end'](I);});}catch(Y){o!=undefined?o(Y):console['error'](Y);R['end'](new Buffer['from'](Y['toString']()));return;}else{if(f['forceCompressionType']=='br'||f['forceCompressionType']=='brotli')try{zlib['brotliCompress'](x,(I,K)=>{if(I){o!=undefined?o(I):console['error'](I);R['end'](new Buffer['from'](I['toString']()));return;}else R['set']({'Content-Encoding':'br'}),f['autoType']==!![]&&R['set']({'Content-Type':S}),R['end'](K);});}catch(I){o!=undefined?o(I):console['error'](I);R['end'](new Buffer['from'](I['toString']()));return;}else{o!=undefined?o('Invalid\x20compression\x20type.'):console['error']('Invalid\x20compression\x20type.');R['end'](new Buffer['from']('Invalid\x20compression\x20type.'));return;}}}}});});f['changeSend']==!![]&&(R['send']=function(l=''){l=new Buffer['from'](l['toString']());var o;try{R['set']({'Cache-Control':f['cacheControl']}),o=H['headers']['accept-encoding'],!o&&(o='');}catch(d){console['error'](d),R['end'](new Buffer['from'](d['toString']()));return;}if(Buffer['byteLength'](l)<f['minCompression']){R['end'](l);return;}if(f['forceCompression']==![]){if(o['match'](/\bgzip\b/))try{zlib['gzip'](l,(S,A)=>{S?R['end'](new Buffer['from'](S)):(R['set']({'Content-Encoding':'gzip'}),R['end'](A));});}catch(S){console['error'](S),R['end'](new Buffer['from'](S['toString']()));return;}else{if(o['match'](/\bdeflate\b/))try{zlib['deflate'](l,(A,O)=>{A?R['end'](new Buffer['from'](A)):(R['set']({'Content-Encoding':'deflate'}),R['end'](O));});}catch(A){console['error'](A),R['end'](new Buffer['from'](A['toString']()));return;}else{if(o['match'](/\bbr\b/))try{zlib['brotliCompress'](l,(O,F)=>{O?R['end'](new Buffer['from'](O)):(R['set']({'Content-Encoding':'br'}),R['end'](F));});}catch(O){console['error'](O),R['end'](new Buffer['from'](O['toString']()));return;}else try{R['end'](l);}catch(F){console['error'](F),R['end'](new Buffer['from'](F['toString']()));return;}}}}else{if(f['forceCompressionType']=='gzip')try{zlib['gzip'](l,(x,u)=>{x?R['end'](new Buffer['from'](x)):(R['set']({'Content-Encoding':'gzip'}),R['end'](u));});}catch(x){console['error'](x),R['end'](new Buffer['from'](x['toString']()));return;}else{if(f['forceCompressionType']['toLocaleLowerCase']()=='deflate')try{zlib['deflate'](l,(u,g)=>{u?R['end'](new Buffer['from'](u)):(R['set']({'Content-Encoding':'deflate'}),R['end'](g));});}catch(u){console['error'](u),R['end'](new Buffer['from'](u['toString']()));return;}else{if(f['forceCompressionType']=='br'||f['forceCompressionType']=='brotli')try{zlib['brotliCompress'](l,(g,Y)=>{g?R['end'](new Buffer['from'](g)):(R['set']({'Content-Encoding':'br'}),R['end'](Y));});}catch(g){console['error'](g),R['end'](new Buffer['from'](g['toString']()));return;}else{fn!=undefined?fn(e):(console['error']('Invalid\x20compression\x20type.'),R['end'](new Buffer['from']('Invalid\x20compression\x20type.')));return;}}}}});if(f['changeJson']==!![]){}if(f['changeJsonp']==!![]){}if(f['changeWrite']==!![]){}if(f['changeExIp']==!![]){var W='',Q=[],a=[],N=[];if(H['headers']){p(H['headers']['true-client-ip'])==!![]&&(a[a['length']]='true-client-ip');p(H['headers']['x-real-ip'])==!![]&&(a[a['length']]='x-real-ip');p(H['headers']['fastly-client-ip'])==!![]&&(a[a['length']]='fastly-client-ip');p(H['headers']['cf-connecting-ip'])==!![]&&(a[a['length']]='cf-connecting-ip');p(H['headers']['x-client-ip'])==!![]&&(a[a['length']]='x-client-ip');p(H['headers']['x-cluster-client-ip'])==!![]&&(a[a['length']]='x-cluster-client-ip');p(H['headers']['forwarded-for'])==!![]&&(a[a['length']]='forwarded-for');p(H['headers']['x-forwarded-for'])==!![]&&(a[a['length']]='x-forwarded-for');p(H['headers']['forwarded'])==!![]&&(a[a['length']]='forwarded');p(H['headers']['x-forwarded'])==!![]&&(a[a['length']]='x-forwarded');for(var M=0x0;M<a['length'];M++){Q[Q['length']]=H['headers'][a[M]];}}H['connection']&&(p(H['connection']['remoteAddress'])==!![]&&(Q[Q['length']]=H['connection']['remoteAddress']),H['connection']['socket']&&p(H['connection']['socket']['remoteAddress'])==!![]&&(Q[Q['length']]=H['connection']['socket']['remoteAddress'])),H['socket']&&p(H['socket']['remoteAddress'])==!![]&&(Q[Q['length']]=H['socket']['remoteAddress']),H['info']&&p(H['info']['remoteAddress'])==!![]&&(Q[Q['length']]=H['info']['remoteAddress']),H['requestContext']&&H['requestContext']['identity']&&p(H['requestContext']['identity']['sourceIp'])==!![]&&(Q[Q['length']]=H['requestContext']['identity']['sourceIp']),f['returnMultiIp']==!![]?H['exip']=Q:H['exip']=Q[0x0];}if(f['flush']==!![]){try{var D=setInterval(()=>{R['flushHeaders']();},f['flushInterval']);}catch(l){console['error'](l);}R['on']('close',()=>{try{clearInterval(D);}catch(o){console['error'](o);}});}b();};function p(H=''){if(f['returnIpType']=='ipv4')return net['isIPv4'](H)?!![]:![];else{if(f['returnIpType']=='ipv6')return net['isIPv6'](H)?!![]:![];else{if(f['returnIpType']=='both')return net['isIP'](H)?!![]:![];}}}}